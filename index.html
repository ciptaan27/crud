<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RME - CRUD Pasien (Tailwind)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-semibold">RME - CRUD Pasien</h1>
            <div id="userArea" class="flex items-center gap-4">
                <span id="roleBadge" class="text-sm text-slate-600"></span>
                <button id="btnLogout" class="hidden bg-red-500 text-white px-3 py-1 rounded">Logout</button>
            </div>
        </header>

        <!-- Login card -->
        <div id="loginCard" class="max-w-md mx-auto bg-white rounded-lg shadow px-6 py-6">
            <h2 class="text-lg font-medium mb-4">Login (demo)</h2>
            <div class="space-y-3">
                <input id="username" class="w-full border rounded px-3 py-2" placeholder="username" />
                <input id="password" type="password" class="w-full border rounded px-3 py-2" placeholder="password" />
                <div class="flex justify-between items-center">
                    <button id="btnLogin" class="bg-blue-600 text-white px-4 py-2 rounded">Login</button>
                    <div class="text-sm text-slate-500">Demo: admin/admin123</div>
                </div>
                <div id="loginMsg" class="text-sm text-red-500"></div>
            </div>
        </div>

        <!-- Main app -->
        <div id="app" class="hidden mt-6">
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <form id="form" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input id="no_rm" class="border rounded px-3 py-2" placeholder="No RM (RM001)" />
                    <input id="nama" class="border rounded px-3 py-2" placeholder="Nama pasien" />
                    <input id="tgl_lahir" type="date" class="border rounded px-3 py-2" placeholder="Tgl Lahir" />

                    <input id="dx" class="border rounded px-3 py-2" placeholder="Dx / Diagnosa" />
                    <input id="bb_kg" type="number" step="0.1" class="border rounded px-3 py-2" placeholder="BB (kg)" />
                    <input id="tb_cm" type="number" step="0.1" class="border rounded px-3 py-2" placeholder="TB (cm)" />

                    <div class="md:col-span-3 flex gap-2 mt-2">
                        <button id="btnSave" class="bg-emerald-600 text-white px-4 py-2 rounded">Simpan</button>
                        <button id="btnUpdate" class="bg-yellow-500 text-white px-4 py-2 rounded hidden">Update</button>
                        <button id="btnCancel" type="button" class="bg-gray-300 px-4 py-2 rounded">Reset</button>
                        <div class="ml-auto flex items-center gap-2">
                            <input id="search" placeholder="Search nama / no_rm / dx"
                                class="border rounded px-3 py-2" />
                            <select id="sortBy" class="border rounded px-2 py-2">
                                <option value="nama">Sort: Nama</option>
                                <option value="no_rm">No RM</option>
                                <option value="tgl_lahir">Tgl Lahir</option>
                            </select>
                            <select id="sortDir" class="border rounded px-2 py-2">
                                <option value="asc">Asc</option>
                                <option value="desc">Desc</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-slate-600" id="info"></div>
                    <div class="flex items-center gap-2">
                        <button id="prevPage" class="px-3 py-1 bg-slate-100 rounded">Prev</button>
                        <span id="pageInfo" class="text-sm"></span>
                        <button id="nextPage" class="px-3 py-1 bg-slate-100 rounded">Next</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm">No RM</th>
                                <th class="px-4 py-2 text-left text-sm">Nama</th>
                                <th class="px-4 py-2 text-left text-sm">Tgl Lahir</th>
                                <th class="px-4 py-2 text-left text-sm">Dx</th>
                                <th class="px-4 py-2 text-left text-sm">BB (kg)</th>
                                <th class="px-4 py-2 text-left text-sm">TB (cm)</th>
                                <th class="px-4 py-2 text-left text-sm">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tbody" class="bg-white divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        /* --- CONFIG --- */
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw-PGKqP05iNurSLAIsMKc-PPLUpwUjOtdRgJe_R_tNrCLsh0segpDi12HII2ocSP7c/exec"; // <--- ganti dengan Web App URL Anda

        /* --- State --- */
        let currentPage = 1;
        let pageSize = 8;
        let currentRole = null;
        let editingId = null;

        /* --- DOM --- */
        const loginCard = document.getElementById('loginCard');
        const app = document.getElementById('app');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const loginMsg = document.getElementById('loginMsg');
        const roleBadge = document.getElementById('roleBadge');
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');

        const no_rm = document.getElementById('no_rm');
        const nama = document.getElementById('nama');
        const tgl_lahir = document.getElementById('tgl_lahir');
        const dx = document.getElementById('dx');
        const bb_kg = document.getElementById('bb_kg');
        const tb_cm = document.getElementById('tb_cm');

        const btnSave = document.getElementById('btnSave');
        const btnUpdate = document.getElementById('btnUpdate');
        const btnCancel = document.getElementById('btnCancel');
        const searchEl = document.getElementById('search');
        const sortBy = document.getElementById('sortBy');
        const sortDir = document.getElementById('sortDir');

        const tbody = document.getElementById('tbody');
        const info = document.getElementById('info');
        const pageInfo = document.getElementById('pageInfo');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');

        /* --- Helper functions --- */
        function showLogin() {
            loginCard.classList.remove('hidden');
            app.classList.add('hidden');
            roleBadge.textContent = '';
            btnLogout.classList.add('hidden');
        }

        function showApp(role) {
            loginCard.classList.add('hidden');
            app.classList.remove('hidden');
            currentRole = role;
            roleBadge.textContent = role ? `Role: ${role}` : '';
            btnLogout.classList.remove('hidden');
        }

        async function apiGet(params = {}) {
            const url = new URL(WEB_APP_URL);
            Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
            const res = await fetch(url.toString());
            return res.json();
        }

        async function apiPost(action, payload = {}) {
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload })
            });
            return res.json();
        }

        /* --- Auth --- */
        btnLogin.addEventListener('click', async () => {
            loginMsg.textContent = '';
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            if (!username || !password) { loginMsg.textContent = "Isi username & password"; return; }
            const res = await apiPost('login', { username, password });
            if (res.status === 'success') {
                // store role in localStorage for demo
                localStorage.setItem('rme_role', res.role);
                showApp(res.role);
                loadData();
            } else {
                loginMsg.textContent = res.message || 'Login gagal';
            }
        });

        btnLogout.addEventListener('click', () => {
            localStorage.removeItem('rme_role');
            currentRole = null;
            showLogin();
        });

        /* --- CRUD actions --- */
        btnSave.addEventListener('click', async (e) => {
            e.preventDefault();
            const payload = {
                no_rm: no_rm.value.trim(),
                nama: nama.value.trim(),
                tgl_lahir: tgl_lahir.value,
                dx: dx.value.trim(),
                bb_kg: bb_kg.value,
                tb_cm: tb_cm.value
            };
            await apiPost('createpatient', payload);
            resetForm();
            currentPage = 1;
            await loadData();
        });

        btnUpdate.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!editingId) return;
            const payload = {
                id: editingId,
                no_rm: no_rm.value.trim(),
                nama: nama.value.trim(),
                tgl_lahir: tgl_lahir.value,
                dx: dx.value.trim(),
                bb_kg: bb_kg.value,
                tb_cm: tb_cm.value
            };
            await apiPost('updatepatient', payload);
            resetForm();
            await loadData();
        });

        btnCancel.addEventListener('click', (e) => {
            e.preventDefault();
            resetForm();
        });

        function resetForm() {
            editingId = null;
            no_rm.value = '';
            nama.value = '';
            tgl_lahir.value = '';
            dx.value = '';
            bb_kg.value = '';
            tb_cm.value = '';
            btnUpdate.classList.add('hidden');
            btnSave.classList.remove('hidden');
        }

        /* --- Table render & actions --- */
        async function loadData() {
            const q = searchEl.value.trim();
            const sb = sortBy.value;
            const sd = sortDir.value;
            const res = await apiGet({ action: 'listPatients', q, page: currentPage, pageSize, sortBy: sb, sortDir: sd });
            if (res.status !== 'success') {
                info.textContent = 'Gagal memuat data';
                return;
            }
            const rows = res.data || [];
            tbody.innerHTML = "";
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
      <td class="px-4 py-2 text-sm">${escapeHtml(r.no_rm || '')}</td>
      <td class="px-4 py-2 text-sm">${escapeHtml(r.nama || '')}</td>
      <td class="px-4 py-2 text-sm">${escapeHtml(r.tgl_lahir || '')}</td>
      <td class="px-4 py-2 text-sm">${escapeHtml(r.dx || '')}</td>
      <td class="px-4 py-2 text-sm">${escapeHtml(r.bb_kg || '')}</td>
      <td class="px-4 py-2 text-sm">${escapeHtml(r.tb_cm || '')}</td>
      <td class="px-4 py-2 text-sm">
        <button class="btnEdit mr-2 bg-blue-500 text-white px-2 py-1 rounded" data-id="${r.id}">Edit</button>
        ${currentRole === 'admin' ? `<button class="btnDel bg-red-500 text-white px-2 py-1 rounded" data-id="${r.id}">Hapus</button>` : ''}
      </td>
    `;
                tbody.appendChild(tr);
            });

            // attach events
            document.querySelectorAll('.btnEdit').forEach(b => b.addEventListener('click', onEdit));
            document.querySelectorAll('.btnDel').forEach(b => b.addEventListener('click', onDelete));

            // paging info
            const total = res.total || 0;
            const page = res.page || 1;
            const pageSize_ = res.pageSize || pageSize;
            info.textContent = `Menampilkan ${rows.length} / ${total} (page ${page})`;
            pageInfo.textContent = `Page ${page}`;
            prevPage.disabled = page <= 1;
            nextPage.disabled = (page * pageSize_) >= total;
        }

        function onEdit(e) {
            const id = e.currentTarget.getAttribute('data-id');
            // fetch single patient
            apiGet({ action: 'getPatient', id }).then(res => {
                if (res.status === 'success') {
                    const p = res.data;
                    editingId = p.id;
                    no_rm.value = p.no_rm || '';
                    nama.value = p.nama || '';
                    tgl_lahir.value = p.tgl_lahir || '';
                    dx.value = p.dx || '';
                    bb_kg.value = p.bb_kg || '';
                    tb_cm.value = p.tb_cm || '';
                    btnUpdate.classList.remove('hidden');
                    btnSave.classList.add('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    alert('Data tidak ditemukan');
                }
            });
        }

        function onDelete(e) {
            if (!confirm('Hapus pasien ini?')) return;
            const id = e.currentTarget.getAttribute('data-id');
            apiPost('deletepatient', { id }).then(() => loadData());
        }

        /* --- Search / sort / paging events --- */
        searchEl.addEventListener('input', () => { currentPage = 1; loadData(); });
        sortBy.addEventListener('change', () => { currentPage = 1; loadData(); });
        sortDir.addEventListener('change', () => { currentPage = 1; loadData(); });

        prevPage.addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadData(); } });
        nextPage.addEventListener('click', () => { currentPage++; loadData(); });

        /* --- Utils --- */
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
        }

        /* --- Init: check stored role --- */
        (function init() {
            const savedRole = localStorage.getItem('rme_role');
            if (savedRole) {
                showApp(savedRole);
                loadData();
            } else {
                showLogin();
            }
        })();
    </script>
</body>

</html>